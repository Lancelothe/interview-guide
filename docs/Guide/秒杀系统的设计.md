## 秒杀系统

1、前端三板斧【扩容】+【限流】+【静态化】+ 【随机丢请求】

2、后端两条路【内存】+【排队】

后端一切服务的瓶颈都来自于数据库——MySQL

## 秒杀场景的特点

- **定时开始，**秒杀时大量用户会在同一时间，抢购同一商品，网站瞬时流量激增。
- **库存有限，**秒杀下单数量远远大于库存数量，只有少部分用户能够秒杀成功。
- **操作可靠，**秒杀业务流程比较简单，一般就是下订单减库存。库存就是用户争夺的“资源”，实际被消费的“资源”不能超过计划要售出的“资源”，也就是不能被“超卖”。

## 系统隔离

业务隔离 + 技术隔离 + 数据库隔离

JS 和 HTML 同时缓存在 CDN 上面，让用户从离自己最近的 CDN 服务器上获取这些信息。

数据库单表500w，估算超过后分库分表。

## 客户端层

- 缓存：页面资源静态化 + CDN缓存

- 防止提前下单: 根据时间戳 Hash值等判断，不要将活动入口提前暴露。

- 限流：设计一些问答或者滑块的功能，减少此类机器人对服务器的压力。

## 代理层

- **缓存，**以 Nginx 为例，它可以缓存用户的信息。假设用户信息的修改没有那么频繁，即使有类似的修改也可以通过更新服务来刷新。总比从服务器上获取效率要高得多。

- **过滤，**既然缓存了用户信息，这里就可以过滤掉一些不满足条件的用户。

  比如相同IP、相同userId频繁请求。

- **限流，**每个服务器集群能够承受的压力都是有限的。代理层可以根据服务器集群能够承受的最大压力，设置流量的阀值。

  通过 Nginx+Lua 合作完成，Lua 从服务注册中心读取服务健康状态，动态调整流量。

## 应用层

### 高并发

并发读：

采用分布式缓存甚至LocalCache来抵抗高并发读。即允许读场景下一定的脏数据，这样只会导致少量原本无库存的下单请求被误认为是有库存的，等到真正写数据时再保证最终一致性，由此做到高可用和一致性之间的平衡。

并发写：

写缓存，降低MySQL并发度；

### 高性能

- 消息队列（削峰填谷、解耦）

  - 削去秒杀场景下的峰值写流量
  - 通过异步处理简化秒杀请求中的业务流程
  - 解耦，实现秒杀系统模块之间松耦合

  当然改成了异步处理，前端在下单的时候，就没法立刻得到下单的结果，**所以前端要做一个【抢购中。。。】的状态页面，在此页面中定时轮询下单结果**。这样就大大提升了系统的吞吐量，降低了系统压力。

- 缓存

  将存库从MySQL前移到Redis中，Redis的写性能和读性能都远高于MySQL，这就解决了高并发下的性能问题。然后通过队列等异步手段，将变化的数据异步写入到DB中。

### 超卖问题

1. 引入队列：将所有写DB操作在单队列中排队，完全串行处理。当达到库存阀值的时候就不在消费队列，并关闭购买功能。这就解决了超卖问题。

   优点：解决超卖问题，略微提升性能。

   缺点：性能受限于队列处理机处理性能和DB的写入性能中最短的那个，另外多商品同时抢购的时候需要准备多条队列。

2. Redis的分布式锁：为了提高效率，会将这个库存信息放到缓存中。以流行的 Redis 为例，用它存放库存信息，由多个线程来访问就会出现资源争夺的情况。也就是分布式程序争夺唯一资源，为了解决这个问题我们需要实现分布式锁。
3. 未付款的订单通过超时任务判断，恢复库存。

需要保证大并发请求时数据库中的库存字段值不能为负，一般有多种方案：

一是在通过事务来判断，即保证减后库存不能为负，否则就回滚；

二是直接设置数据库字段类型为无符号整数，这样一旦库存为负就会在执行 SQL 时报错；

三是使用 CASE WHEN 判断语句

```
UPDATE item SET inventory = CASE WHEN inventory >= xxx THEN inventory-xxx ELSE inventory END
```

业务手段保证商品卖的出去，技术手段保证商品不会超卖，库存问题从来就不是简单的技术难题，解决问题的视角是多种多样的。

### 减库存的方式

- 下单减库存。买家下单后，扣减商品库存。下单减库存是最简单的减库存方式，也是控制最为精确的一种
- 付款减库存。买家下单后，并不立即扣减库存，而是等到付款后才真正扣减库存。但因为付款时才减库存，如果并发比较高，可能出现买家下单后付不了款的情况，因为商品已经被其他人买走了
- 预扣库存。这种方式相对复杂一些，买家下单后，库存为其保留一定的时间（如 15 分钟），超过这段时间，库存自动释放，释放后其他买家可以购买

![这一次，彻底弄懂“秒杀系统”](https://www.javazhiyin.com/wp-content/uploads/2019/10/java4-1571741299.jpg)



[秒杀系统设计的 5 个要点：前端三板斧＋后端两条路！ \- 云\+社区 \- 腾讯云](https://cloud.tencent.com/developer/article/1142596)

[这一次，彻底弄懂“秒杀系统”\-Java知音](https://www.javazhiyin.com/46581.html)

[如何设计一个秒杀系统\-云栖社区\-阿里云](https://yq.aliyun.com/articles/618443)

[秒杀业务架构优化之路 \- InfoQ](https://www.infoq.cn/article/flash-deal-architecture-optimization/?spm=a2c4e.10696291.0.0.602919a4ugIkxF)

[如何设计秒杀系统？ \- 知乎](https://www.zhihu.com/question/54895548)

[架构师手把手教你如何设计一个秒杀系统？ \- 简书](https://www.jianshu.com/p/729f1f0f6e18)

[一个秒杀系统的设计思考 \- 阿哲的专栏 \- SegmentFault 思否](https://segmentfault.com/a/1190000020970562)

[如何设计一个小而美的秒杀系统？](https://www.ibm.com/developerworks/cn/web/wa-design-small-and-good-kill-system/index.html)

[Java生鲜电商平台\-秒杀系统最全设计?\(小程序/APP\) \- 巨人大哥 \- 博客园](https://www.cnblogs.com/jurendage/p/13417590.html)